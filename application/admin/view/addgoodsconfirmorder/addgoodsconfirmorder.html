<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11">
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
        <link rel="stylesheet" type="text/css" href="/static/layui/css/layui.css">
        <link rel="stylesheet" type="text/css" href="/static/UI-jquery/jquery-ui.min.css">
        <link rel="stylesheet" type="text/css" href="/static/css/public.css">
    </head>
        <style>
            .btnPicLightBg{
                background: #8D8D8D;
            }
            .hide{
                display: none;
            }
            .textcenter{
                text-align: center;
                left: 50%;
            }
            .layui-table-style td{padding: 4px 1px;  border: 1px solid #8A8A8A}
            .layui-table-style th{ border: 1px solid #8A8A8A;  color:black}
        </style>
    <body>
        <form class="layui-form layui-form-pane" action="">
        	<div class="toph2">
            	<h2>订货确认单</h2>
           	</div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label light_gray">日期</label>
                    <div class="layui-input-inline">
                        <input type="text" disabled name="cs_belong_create_time" id="cs_belong_create_time" autocomplete="on" class="layui-input light_gray" value="{$date}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">接收时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="order_date" id="order_date" autocomplete="on" class="layui-input Wheat">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label light_gray">流水号</label>
                    <div class="layui-input-inline">
                        <input type="text" disabled name="cs_id" id="cs_id" lay-verify="" autocomplete="on" placeholder="" class="layui-input light_gray">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">状态</label>
                    <div class="layui-input-inline Wheat">
                        <select name="cs_info_state" id="cs_info_state">
                            <option value="" disabled="" >选择</option>
                            <option value="1" selected="">处理中</option>
                            <option value="2">已完成</option>
                            <option value="3">取消</option>
                            <option value="4">备货</option>
                            <option value="6">缺货</option>
                        </select>
                    </div>
                </div>
            </div>

<!--             <div>
                <h3 class="textcenter" style="margin-bottom: -30px">物流信息</h3>
                <div>
                    <input type="button" value="添加物流" id="btn_add_logistics_item" class="layui-btn layui-btn-normal" lay-filter="btn_add_logistics_item">
                    <input type="button" value="删除" id="btn_del_logistics_item" class="layui-btn layui-btn-normal" lay-filter="btn_del_logistics_item">
                </div>
            </div> -->
            <h3>物流信息</h3>
            <div class="layui-form-item">
            <table class="layui-table" id="tablelogistics">
                <colgroup>
                    <col width="20%">
                    <col width="45%">
                    <col width="25%">
                    <col width="10%">
                </colgroup>
                <thead>
                <tr class="Wheat">
                    <!--<th>选择</th>-->
                    <th>发货日期</th>
                    <th>货场</th>
                    <th>物流单号</th>
                    <th>件数</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            </div>
            <h3>订单信息</h3>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">总部门：</label>
                    <div class="layui-input-inline Wheat">
                        <select id="build_organize_id" name="build_organize_id" lay-filter="build_organize_id">
                           <!--  <option value="" selected>请选择</option> -->
                            {volist name="companylist" id="vo"}
                                {if condition="$vo.organize_id eq 1"}
                                    <option value="{$vo.organize_id}" selected>{$vo.organize_name}</option>
                                {else /}
                                    <option value="{$vo.organize_id}">{$vo.organize_name}</option>
                                {/if}
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">子部门</label>
                    <div class="layui-input-inline Wheat">
                        <select id="build_department_id" name="build_department_id" lay-filter="build_department_id">
                            <option value="" selected>请选择</option>
                            {volist name="departlist" id="vo"}
                                <option value="{$vo.organize_id}">{$vo.organize_name}</option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">区域经理</label>
                    <div class="layui-input-inline Wheat">
                        <!--<select id="user_id" name="user_id" lay-filter="user_id">-->
                            <!--<option value="" selected>请选择</option>-->
                        <!--</select>-->
                        <input type="text" id="user_id" name="user_id" lay-filter="user_id" oninput="detectinputtext(this);"  class="layui-input Wheat">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">收货人姓名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receiver_name" id="receiver_name" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat" oninput="detectinputtext(this);"> </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">收货人电话</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receiver_phone" id="receiver_phone" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat" oninput="detectinputphone(this);"> </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">收货地址</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receiver_address" id="receiver_address" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat" oninput="detectinputtext(this);">
                    </div>
                </div>
            </div>
            <h3>费用情况</h3>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">订制费用</label>
                    <div class="layui-input-inline">
                        <input type="text" name="customization_fee" id="customization_fee" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat" oninput="detectinputtext(this);"> </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">运费</label>
                    <div class="layui-input-inline">
                        <input type="text" name="transfer_fee" id="transfer_fee" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat" oninput="detectinputtext(this);"> </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">运费方式</label>
                    <div class="layui-input-inline Wheat">
                        <select name="transfer_mode" id="transfer_mode">
                            <option value="" disabled="" selected="">选择</option>
                            <option value="0">到付</option>
                            <option value="1">现金</option>
                            <option value="2">代付</option>
                            <option value="3">公司付</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label Wheat">备注</label>
                <div class="layui-input-block">
                    <input type="text" name="comment" id="comment" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat" oninput="detectinputtext(this);">
                    <!--<textarea name="comment" id="comment" placeholder="请输入" class="layui-textarea Wheat"></textarea>-->
                </div>
            </div>
            <h3>订制情况</h3>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label Wheat">货期回复</label>
                    <div class="layui-input-inline">
                        <input type="text" name="delivery_date_reply" id="delivery_date_reply" lay-verify="" autocomplete="on" placeholder="" class="layui-input Wheat"> </div>
                </div>
                <div class="layui-inline">
                	<input type="button" id="uncofginfo" class="layui-btn" target="_blank" value="增加非定型产品订货确认单">
                	<input type="button" id="lookuncofginfo" class="layui-btn" target="_blank" value="查看非定型产品订货确认单">
                    <input type="button" id="deluncofginfo" class="layui-btn" target="_blank" style="color: red" value="删除非定型产品订货确认单">
                	<input type="button" id="uploadpic" name="uploadpic" class="layui-btn" target="_blank" value="上传咨询表">
                	<input type="button" id="lookpic" class="layui-btn" target="_blank" value="查看咨询表">
                    <input type="button" id="delpic" class="layui-btn" target="_blank" style="color: red" value="删除咨询表" title="删除新上传的未保存的咨询表（已保存的咨询表无法删除）">
               	</div>
            </div>
            <h3>确认单产品</h3>
            <div class="layui-form-item" id="divorderproduct">
            </div>
            <div>
                <h3 class="textcenter" >未发货产品</h3>
                <!--<div>-->
                    <!--<input type="button" value="添加清单" id="btn_add_order_item" class="layui-btn layui-btn-normal" lay-submit="" lay-filter="add_order_item">-->
                <!--</div>-->
            </div>
            <table class="layui-table layui-table-style" id="tableorder">
                <colgroup>
                </colgroup>
                <thead>
                    <tr class="Wheat">
                        <th>序号</th>
                        <th>型号</th>
                        <th>产品名称</th>
                        <th>产品分类</th>
                        <th>品牌</th>
                        <th>生产地</th>
                        <th>单位</th>
                        <th>数量</th>
                        <th class="dark_blue">产品状态</th>
                        <th class="dark_blue">备注</th>
                        <th class="dark_blue">操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div class="layui-form-item">
                <div class="layui-btn-container textcenter">
                    <input type="button" value="保存" class="layui-btn layui-btn-normal" lay-submit="" id="save" lay-filter="save">
                </div>
            </div>
        </form>
        <script type="text/javascript" src="/static/js/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="/static/UI-jquery/jquery-ui.min.js"></script>
        <script type="text/javascript" src="/static/layui/layui.js"></script>
        <script type="text/javascript" src="/static/js/commondetect.js"></script>
        <script type="text/javascript" src="/static/UI-jquery/jquery-ui.js" ></script>
        <script type="text/javascript">
            var isLoading = true;
            //var hasUploadPic = false;
            var cs_id = "";   //订单id 新增无；
            var ofg_info_id = "";
            var fee_info_id = "";
            var unc_ofg_info_id = "";
            var consult_sheet_file = "";
            var cs_belong_id = "";
            var cs_belong_create_time = "";
            var ofg_info_id = "";
            var fee_info_id = "";
            var unc_ofg_info_id = "";
            var consult_sheet_file = "";
            var consult_sheet_file_new = "";
            var isSave = false;
            var type = 0; //当前页面模式 说明：0：不可编辑 1：编辑
            var uncofginfo = null;      //非常规订单数据 包含unc_ofg_info，清单明细：搜索unc_ofg_items，删除表del_unc_ofg_detail_id_arr
            var del_logistics_id_arr = new Array();//删除物流信息id
            var del_unc_ofg_detail_id_arr = new Array();//删除非定型订单明细id
            var del_ogcugi_id_arr = new Array(); //删除订单明细id

            var user_id = 0;


            //禁止backspace键
            document.onkeypress = forbidBackSpace;
            document.onkeydown = forbidBackSpace;

            window.onbeforeunload = onbeforeunload_handler;
            function onbeforeunload_handler(e)
            {
                onunload_handler();
                //return "确定离开此页面？"
            }

            function onunload_handler() {
                console.log("离开了这个页面！！！");
                if (consult_sheet_file_new != "" && !isSave){
                    var index = top.layer.msg('加载中', {icon: 16});
                    var jq = layui.jquery;
                    jq.ajax({
                        url: "{:url('admin/addgoodsconfirmorder/delcachefile')}",//php文件路径
                        data: {
                            delFileName:consult_sheet_file_new
                        },
                        type: 'POST',
                        async: false,
                        success: function(res) {
                            console.log("没保存，删除了缓存咨询表！！！！！！！！！！！！！");
                            consult_sheet_file_new = "";
                            top.layer.close(index);
                        }
                    })
                }
            }

            layui.use(['form', 'jquery','layedit', 'laydate','upload'], function () {
                var form = layui.form,
                    jq = layui.jquery,
                    layer = layui.layer,
                    layedit = layui.layedit,
                     upload = layui.upload,
                    laydate = layui.laydate;
                /*日期*/
                laydate.render({
                    elem: '#cs_belong_create_time'
                    ,position: 'fixed'
                    ,theme: 'molv'
                });

                laydate.render({
                    elem: '#order_date'
                    ,type: 'datetime'
                    ,position: 'fixed'
                    ,theme: 'molv'
                });

                laydate.render({
                    elem: '#delivery_date'
                    ,position: 'fixed'
                    ,theme: 'molv'
                });
                laydate.render({
                    elem: '#delivery_date_reply'
                    ,position: 'fixed'
                    ,theme: 'molv'
                });
                laydate.render({
                    elem: '.lala'
                    ,position: 'fixed'
                    ,theme: 'molv'
                });
                //上传文件
                var uploadPic = upload.render({
                    elem: '#uploadpic' //绑定元素
                    ,method: 'POST'
                    ,url: "{:url('admin/addgoodsconfirmorder/uploadconsultform')}" //上传接口
                    ,acceptMime: 'image/*'
                    ,size:'10240'
                    ,error: function(obj){
                        consult_sheet_file_new = "";
                        top.layer.closeAll('loading');
                        top.layer.msg('上传失败！',{icon:2});
                        //请求异常回调
                        setConsultSheet();
                    }
                    ,before: function(obj){
                        if (consult_sheet_file_new != ""){
                            var url = jq(this).attr('url');
                            url = url + '?delFileName=' + consult_sheet_file_new;
                            jq(this).attr('url',url);
                        }
                        console.log(this);
                        top.layer.load({icon:16}); //上传loading
                        setConsultSheet();
                    }
                    ,done: function(res){
                        top.layer.closeAll('loading');
                        console.log(res);
                        if(res.code == '1'){
                            var fileName = res.fileName;
                            var pathName = res.pathName;//暂无用
                            top.layer.msg(res.msg,{icon:1});
                            if (fileName === undefined || fileName ==""){

                            }else {
                                consult_sheet_file_new = fileName;
                            }
                        }
                        if(res.code == '0'){
                            top.layer.msg(res.msg,{icon:2});
                            consult_sheet_file_new = "";
                        }
                        setConsultSheet();
                    }
                });

                //网页加载时  赋值使用
                $(document).ready(function(){
                    isLoading = true;
                    type = {$type};
                    /*********test*********/
                    var list = {$productlist};
                    console.log(list);
                    for (var obj in list){
                        $('#divorderproduct').append(
                            '<div class="layui-inline"><label class="layui-form-label Wheat">'+list[obj].cs_product_name+'</label>' +
                            '<div class="layui-input-inline"><input type="text" name="'+list[obj].cs_product_id+'" id="'+ list[obj].cs_product_id +'" lay-verify="" autocomplete="on" ' +
                            'placeholder="" class="layui-input Wheat" oninput="detectinputnumber(this);"> </div></div>')
                    }

                    layui.form.render();
                    /******************/
                    var order_info = {$order_info};
                    console.log(order_info);
                    if(order_info == "-1"){
                        //addLogisticsItem(null);      /*物流信息不需要手动填写*/
                        setHtmlType();
                        top.layer.closeAll('loading');
                        isLoading = false;
                        addGoodsTableRow();
                        return ;
                    }
                    console.time("timer");
                    setDBDateToHtml(order_info);
                    setHtmlType();
                    layui.form.render('select');
                    isLoading = false;
                    addGoodsTableRow();
                    console.timeEnd("timer");
                });
                //监听提交
                form.on('submit(save)', function (uidata) {
                    /*物流信息不需要填写*/
                    // var logistics_info = getlogisticsInfo();
                    // if(logistics_info == null){
                    //     layer.msg('请填写完整物流信息！',{icon:2});
                    //     return false;
                    // }
                    // var logistics_info_length = logistics_info.length;
                    // if(logistics_info_length < 1){
                    //     layer.msg('请填写物流信息！',{icon:2});
                    //     return false;
                    // }

                    jq = layui.jquery;
                    var data = uidata.field;
                    var retVf = verification(data);
                    if(!retVf){
                        return false;
                    }

                    var cs_belong = csBelong(data);
                    console.log('下列输入订货所属信息：');
                    console.log(cs_belong);
                    var ofg_info = ofgInfo(data);
                    console.log('下列输入订单信息：');
                    console.log(ofg_info);
                    var fee_info = feeInfo(data);
                    console.log('下列输入费用情况：');
                    console.log(fee_info);
                    var order_goods_cs_undeliver_goods_info = getGoodsTable();
                    if(order_goods_cs_undeliver_goods_info == false)
                        return false;
                    console.log('下列输入清单信息：');
                    console.log(order_goods_cs_undeliver_goods_info);
                    var product_number = order_goods_cs_undeliver_goods_info.length;
                    var unc_ofg_info = null;
                    var unc_ofg_detail = null;
                    if (uncofginfo != null){
                        del_unc_ofg_detail_id_arr = uncofginfo.del_unc_ofg_detail_id_arr;
                        unc_ofg_info = uncofginfo.unc_ofg_info;
                        var unc_ofg_items = uncofginfo.unc_ofg_items;
                        var length = unc_ofg_items.length;
                        product_number += length;
                        for (var i = 0; i < length; i++){
                            if (unc_ofg_detail == null){
                                unc_ofg_detail = [];
                            }
                            if(unc_ofg_items[i]['isExistModel'] == undefined || unc_ofg_items[i]['isExistModel'] == null||unc_ofg_items[i]['isExistModel'] == '')
                            {
                                unc_ofg_items[i]['isExistModel'] = true;
                            }
                            if(unc_ofg_items[i]['unc_product_id'] == undefined || unc_ofg_items[i]['unc_product_id'] == null||unc_ofg_items[i]['unc_product_id'] == '')
                            {
                                unc_ofg_items[i]['unc_product_id'] = -1;
                            }
                            unc_ofg_detail[i] = unc_ofg_items[i];
                        }
                    }
                    console.log('下列非常规订单信息：');
                    console.log(unc_ofg_info);
                    console.log('下列非常规清单信息：');
                    console.log(unc_ofg_detail);
                    var order_goods_cs_info = getorderGoodsInfo(data);
                    if(order_goods_cs_info == false)
                        return false;
                    order_goods_cs_info.product_number = product_number;
                    console.log('下列输入订货确认单信息：');
                    console.log(order_goods_cs_info);
                    /* ***************************************************** 说明 *********************************************************** */
                    /*
                    如果表
                         unc_ofg_detail  uod_id == "" 表示新增
                         logistics_info logistics_id == "" 表示新增  否则 cs_id  user_id  time_stamp 使用原来值php不要赋值

                         del_logistics_id_arr  删除表 logistics_info           //删除物流信息id
                         del_unc_ofg_detail_id_arr  删除表 unc_ofg_detail      //删除非定型订单明细id
                         del_ogcugi_id_arr 删除表 order_goods_cs_undeliver_goods_info  //删除订货确认单未发货清单
                     */
                    jq.ajax({
                        url: "{:url('admin/addgoodsconfirmorder/addcs')}",//php文件路径
                        data: {
                                order_goods_cs_info:order_goods_cs_info,
                                //logistics_info:logistics_info,
                                cs_belong:cs_belong,
                                ofg_info:ofg_info,
                                fee_info:fee_info,
                                order_goods_cs_undeliver_goods_info:order_goods_cs_undeliver_goods_info,
                                unc_ofg_info:unc_ofg_info,
                                unc_ofg_detail:unc_ofg_detail,
                                del_logistics_id_arr:del_logistics_id_arr,
                                del_unc_ofg_detail_id_arr:del_unc_ofg_detail_id_arr
                                },
                        type: 'POST',
                        success: function(e) {
                            var layer = layui.layer;
                            if (e != null){
                                if(e.code == 1){
                                    isSave = true;
                                    top.layer.msg(e.msg);
                                    location.href = "{:url('admin/addgoodsconfirmorder/addgoodsconfirmorder')}";
                                }else if(e.code == 0){
                                    top.layer.alert(e.msg);
                                }else if(e.code == -1){
                                    top.layer.alert('异常：' + e.msg);
                                }
                            }else {
                                top.layer.alert('保存失败！');
                            }
                        }
                    });
                    return false;
                });
                //监听选择公司
                form.on('select(build_organize_id)',function (data) {
                    jq('#build_department_id').empty();
                    jq('#user_id').empty();
                    jq('#build_department_id').append("<option value='' selected>请选择</option>");
                    jq('#user_id').append("<option value='' selected>请选择</option>");
                    form.render('select');
                    if (data.value == ""){
                        return;
                    }
                    jq.post("{:url('admin/addgoodsconfirmorder/getdepartmentinfo')}",{'param':data.value},function (data) {
                        //console.log(data);
                        for (var item in data){
                            jq('#build_department_id').append("<option value='" + data[item]['organize_id'] + "'>" + data[item]['organize_name'] + "</option>>");
                        }
                        form.render('select');
                    })
                });
                // //监听选择部门
                // form.on('select(build_department_id)',function (data) {
                //     jq('#user_id').empty();
                //     jq('#user_id').append("<option value='' selected>请选择</option>");
                //     if(data.value == ''){
                //         form.render('select');
                //         return;
                //     }
                //     jq.post("{:url('admin/addgoodsconfirmorder/getdspmanagerinfo')}",{'param':data.value},function (data) {
                //         for (var item in data){
                //             jq('#user_id').append("<option value='" + data[item]['user_id'] + "' phone='" + data[item]['phone'] + "'>" + data[item]['fullname'] + "</option>>");
                //         }
                //         form.render('select');
                //     })
                // });
                //非定型订单弹窗
                jq('#uncofginfo').click(function () {
                    top.layer.open({
                        type:2,
                        title:'非定型产品订货单',
                        area:['80%','90%'],
                        shade: [0.7, '#393D49'],
                        skin: 'layui-layer-molv',
                        maxmin:true,
                        content:"{:url('admin/uncofginfo/uncofginfo')}?type=1&parenttype=" + {$type},
                        btn:['打印预览','确定','退出'],
                        btnAlign: 'c',
                        yes:function (index,layero) {
                            var  iframeWin = top.window[layero.find('iframe')[0]['name']];
                            var  ret = iframeWin.getPrintData();
                            if(ret == null){
                                return;
                            }
                            var strJson = JSON.stringify(ret);
                            var rstrJson = strJson.replaceAll('"',"/$/@");
                                top.layer.open({
                                    type: 2,
                                    area: ['650px', '80%'],
                                    shade: 0.6,
                                    shadeClose:true,
                                    title: ['打印预览界面','text-align:center'],
                                    resize:false,
                                    btn: ['打印','取消'],
                                    content: "{:url('admin/addgoodsconfirmorder/printuncorder')} ?printdata="+ rstrJson,
                                    yes:function(index,layero){
                                        var iframeWin = top.window[layero.find('iframe')[0]['name']];
                                        iframeWin.print();
                                    }
                                });
                        },
                        btn2: function (index,layero) {
                            var  iframeWin = top.window[layero.find('iframe')[0]['name']];
                            var  ret = iframeWin.getData();

                            if (ret == false){
                                return false;
                            }else if (ret == null){
                                uncofginfo = ret;
                                top.layer.close(index);
                            }else {
                                uncofginfo = ret;
                                top.layer.close(index);
                            }
                            setDelUncofginfoVis();
                        },
                        btn3: function (index) {
                            console.log(index);
                            layer.close(index);
                        }
                    });
                    return false;
                })
                //删除非定型订单
                jq('#deluncofginfo').click(function () {
                    top.layer.confirm('确定删除此非定型产品订货确认单？', {
                        btn: ['确定','取消'] //按钮
                    }, function(index){
                        top.layer.close(index);
                        uncofginfo = null;
                        setDelUncofginfoVis();
                    });
                });
                jq('#lookuncofginfo').click(function () {
                    var type = {$type};
                    var url = "";

                    if(type == 0){
                        url = "{:url('admin/uncofginfo/uncofginfo')}?type=0&parenttype=" + {$type} + "&cs_id=" + cs_id;
                    }else if(type == 1){
                        url = "{:url('admin/uncofginfo/uncofginfo')}?type=0&parenttype=" + {$type};
                    }
                    top.layer.open({
                        type:2,
                        title:'查看非定型产品订货单',
                        area:['80%','90%'],
                        shade: [0.7, '#393D49'],
                        skin: 'layui-layer-molv',
                        maxmin:true,
                        content:url,
                        btn:['退出'],
                        btnAlign: 'c',
                        yes:function (index,layero) {
                            top.layer.close(index);
                        }
                    });
                    return false;
                })
                //添加清单明显
                jq('#btn_add_order_item').click(function () {
                    openWindow();
                    return false;
                });
                //编辑行
                jq(document).on('click', '.edit_btn', function() {
                    // var text = jq(this).parent().parent();
                    // var tableRowIndex = jq(text[0].cells[0].innerHTML).text();
                    // openWindow(tableRowIndex);
                });
                //删除行
                jq(document).on('click', '.del_btn', function(){
                    var text = jq(this).parent().parent();

                    top.layer.confirm('确定删除这条未发货产品清单？', {
                        btn: ['确定','取消'] //按钮
                    }, function(index){
                        top.layer.close(index);
                        var ogcugi_id = jq(text).attr("ogcugi_id");
                        if (ogcugi_id === undefined || ogcugi_id == ""){
                            //return;
                        }else {
                            del_ogcugi_id_arr.push(ogcugi_id);
                        }
                        jq('#tableorder')[0].deleteRow(jq(text[0].cells[0].innerHTML).text());
                        var table = document.getElementById("tableorder"); //获得整个表格对象
                        if(table.rows.length == 1)
                        {
                            addGoodsTableRow();
                        }
                        else
                        {
                            for(var i = 1; i <= table.rows.length;i++){
                                var rowObj = table.rows[i]
                                var cell = rowObj.cells[0];
                                cell.innerHTML ="<a>"+ i+"</a>";
                            }
                        }
                    });
                });

                jq('#lookpic').click(function () {
                    console.log("查看咨询表被点击了");
                    //var consult_sheet_file = "";
                    //var consult_sheet_file_new = "";
                    var fileName = '';
                    var pathName = '';

                    if(consult_sheet_file!= "" && consult_sheet_file_new == ""){
                        //没有新文件上传
                        fileName = consult_sheet_file;
                        pathName = '/uploads/' + consult_sheet_file;
                    }else if (consult_sheet_file == "" && consult_sheet_file_new != ""){
                        //只有新文件
                        fileName = consult_sheet_file_new;
                        pathName = '/cachefile/' + consult_sheet_file_new;
                    }else if (consult_sheet_file != "" && consult_sheet_file_new != ""){
                        //新旧都有
                        fileName = consult_sheet_file_new;
                        pathName = '/cachefile/' + consult_sheet_file_new;
                    }else {
                        return;
                    }

                    var html1 = "<img src='"+ pathName +"'>";

                    top.layer.open({
                        type: 1,
                        title: fileName,
                        area: ['80%', '80%'],
                        maxmin: true,
                        skin: 'layui-layer-nobg', //没有背景色
                        shadeClose: true,
                        content: html1,
                    });


                    /*var json = {
                        "data": [   //相册包含的图片，数组格式
                            {
                                "alt": fileName,
                                "pid": 1, //图片id
                                "src": pathName, //原图地址
                                "skin": 'layui-layer-nobg',
                            }
                        ]
                    };
                    layer.photos({
                        skin: 'layui-layer-nobg',
                        photos: json
                        ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
                    });*/
                });
                //删除未保存咨询表
                jq('#delpic').click(function () {
                    top.layer.confirm('删除新上传的未保存的咨询表？<br/><span style="color: red">（已保存的咨询表无法删除）</span>', {
                        btn: ['确定','取消'] //按钮
                    }, function(index){
                        top.layer.close(index);
                        delCacheConsultSheet();
                    });
                });
                jq("#user_id").autocomplete({
                    source:function(request,response){
                        jq.ajax({
                            url:"{:url('index/common/getserachmanarger')}",
                            type:"POST",
                            dataType:"json",
                            data:{serachText:jq('#user_id').val(),organize_id:jq('#build_department_id').val(),role_name:'经理'},
                            success:function(data){
                                if(data == null || data == undefined)
                                    return ;
                                response(jq.map(data,function(item){
                                    return{
                                        label:item.fullname,
                                        value:item.fullname,
                                    }
                                }));
                            },
                        });
                    },
                    select: function (event, ui) {
                        jq('#user_id').val(ui.item.fullname);
                        jq("#user_id").blur();
                    },
                });
                jq("#user_id").blur(function () {
                    var user = jq('#user_id').val();
                    if(user == '')
                        return ;
                    jq.ajax({
                        url: "{:url('admin/addgoodsconfirmorder/judgemanagerexist')}",
                        type: "POST",
                        dataType: "json",
                        async: false,
                        data: { fullname: user,department_id:jq('#build_department_id').val()},
                        success: function (data) {
                            if(data == "" || data == null || data === undefined) {
                                top.layer.confirm('经理: <span style="color: red">'+user+'</span> 在数据库不存在', {
                                    btn: ['是'] //按钮
                                });
                                jq('#user_id').val('');

                            } else {
                               user_id = data[0]['user_id'];
                               console.log(data);
                                console.log(0000);
                            }
                        },
                    });


                })

            });

            //编辑或者新增Item 窗体，tableRowIndex：表序号 新增不填
            function openWindow(tableRowIndex) {
                var jq = layui.jquery;
                var layer = layui.layer;
                top.layer.open({
                    type: 2,
                    title: '新增清单',
                    area: ['880px', '400px'],
                    shade: [0.7, '#393D49'],
                    skin: 'layui-layer-molv',
                    maxmin: true,
                    content: "{:url('admin/addgoodsconfirmorderitem/addgoodsconfirmorderitem')}",
                    btn: ['确定', '退出'],
                    yes: function (index, layero) {
                        var iframeWin = top.window[layero.find('iframe')[0]['name']];
                        var orderItem = iframeWin.saveOrderItem();
                        if (orderItem == "" || orderItem == null) {
                            return false;
                        }

                        if (tableRowIndex === undefined || tableRowIndex == null || tableRowIndex == "") {
                            var rowIndex = jq('#tableorder')[0].rows.length;
                            addTableItem(orderItem, rowIndex);
                            top.layer.msg('新增清单成功，序号：'+ rowIndex,{icon:1});
                            iframeWin.clear();
                        }
                        else {
                            jq('#tableorder')[0].deleteRow(tableRowIndex);
                            addTableItem(orderItem, tableRowIndex);
                            top.layer.close(index);
                        }

                        //top.layer.close(index);
                    },
                    btn2: function (index) {
                        top.layer.close(index);
                    },
                    success: function (layero, index) {
                        if (tableRowIndex === undefined || tableRowIndex == null || tableRowIndex == "") {
                        }
                        else {
                            var rowData = getTableItemToDBObject(tableRowIndex);
                            var iframeWin = top.window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                            iframeWin.loadingData(rowData);
                        }
                    },
                });
            }
            //订货确认单信息
            function getorderGoodsInfo(data) {
                var order_goods_cs_info = new Object();
                order_goods_cs_info.cs_id = cs_id;
                order_goods_cs_info.ofg_info_id = ofg_info_id;
                order_goods_cs_info.fee_info_id = fee_info_id;
                order_goods_cs_info.order_date = data['order_date'];
                order_goods_cs_info.delivery_date_reply = data['delivery_date_reply'];
                order_goods_cs_info.unc_ofg_info_id = unc_ofg_info_id;
                order_goods_cs_info.consult_sheet_file_old = consult_sheet_file;
                order_goods_cs_info.consult_sheet_file = consult_sheet_file_new;
                order_goods_cs_info.cs_info_state = data['cs_info_state'] == "" ? -1: data['cs_info_state'];
                order_goods_cs_info.product_number = 0;

                $("#divorderproduct input[type='text']").each(function(){
                    order_goods_cs_info[this.id] = this.value == "" ? 0:this.value;
                });
                /*order_goods_cs_info.delivered_total = data['delivered_total'] == "" ? 0 : data['delivered_total'];
                order_goods_cs_info.delivered_pa = data['delivered_pa'] == "" ? 0 : data['delivered_pa'];
                order_goods_cs_info.delivered_conference = data['delivered_conference'] == "" ? 0 : data['delivered_conference'];
                order_goods_cs_info.delivered_customization = data['delivered_customization'] == "" ? 0 : data['delivered_customization'];
                order_goods_cs_info.delivered_record = data['delivered_record'] == "" ? 0 : data['delivered_record'];
                order_goods_cs_info.delivered_metro = data['delivered_metro'] == "" ? 0 : data['delivered_metro'];
                order_goods_cs_info.delivered_aux = data['delivered_aux'] == "" ? 0 : data['delivered_aux'];
                order_goods_cs_info.delivered_gift = data['delivered_gift'] == "" ? 0 : data['delivered_gift'];
                order_goods_cs_info.delivered_album = data['delivered_album'] == "" ? 0 : data['delivered_album'];*/


                return order_goods_cs_info;
            }
            //订单信息
            function ofgInfo(data) {

                var ofg_info = new Object();
                ofg_info.ofg_info_id = ofg_info_id;                 //后台添加
                ofg_info.receiver_name = data['receiver_name'];
                ofg_info.receiver_phone = data['receiver_phone'];
                ofg_info.receiver_address = data['receiver_address'];
                ofg_info.user_id = user_id;
                return ofg_info;
            }
            //费用情况
            function feeInfo(data) {
                var fee_info = new Object();
                fee_info.fee_info_id = fee_info_id;
                var customization_fee = data['customization_fee'];
                if (typeof(customization_fee) == 'undefined' || customization_fee == ""){
                    customization_fee = 0;
                }
                fee_info.customization_fee = customization_fee;
                var transfer_fee = data['transfer_fee'];
                if(transfer_fee == ""){
                    transfer_fee = 0;
                }

                fee_info.transfer_fee = transfer_fee;
                fee_info.transfer_mode = data['transfer_mode'];
                fee_info.comment = data['comment'];
                return fee_info;
            }
            //订单所属
            function csBelong(data) {
                var jq = layui.jquery;
                var cs_belong = new Object();
                cs_belong.cs_belong_id = cs_belong_id;
                cs_belong.cs_id = cs_id;
                cs_belong.build_organize_id = data['build_organize_id'];
                cs_belong.build_user_id = user_id;
                cs_belong.cs_belong_create_time = cs_belong_create_time;
                cs_belong.build_user_name = data['user_id'];
                cs_belong.build_organize_name = jq("#build_organize_id").find("option:selected").text();
                cs_belong.build_department_id = data['build_department_id'];
                cs_belong.build_department_name = jq("#build_department_id").find("option:selected").text();
                return cs_belong;
            }
            //获取物流信息
            function getlogisticsInfo() {
                var jq = layui.jquery;
                var mytable = document.getElementById('tablelogistics');
                var rows = mytable.rows.length;
                var retArray = [];
                for(var i = 1; i < rows; i++){
                    var rowdata = {};
                    var rowObj = mytable.rows[i]
                    for(var j = 0,cells = rowObj.cells.length; j<cells; j++){
                        var cellData = rowObj.cells[j].getElementsByTagName("input")[0].value;
                        rowdata[j] = cellData;
                    }
                    var goods_yard_name = rowdata[1].trim();
                    var transfer_order_num = rowdata[2].trim();
                    var delivery_date = rowdata[0].trim();
                    var count = rowdata[3].trim();
                    if (goods_yard_name == "" && transfer_order_num == "" && delivery_date == "" && count == ""){
                        continue;
                    }
                    if (goods_yard_name == "" || transfer_order_num == "" || delivery_date == "" || count == ""){

                        return null;
                    }
                    var logistics_info = new Object();
                    var logistics_id = jq(rowObj).attr('logistics_id');
                    var cs_id = jq(rowObj).attr('cs_id');
                    var user_id = jq(rowObj).attr('user_id');
                    var time_stamp = jq(rowObj).attr('time_stamp');
                    logistics_info.logistics_id = logistics_id;
                    logistics_info.cs_id = cs_id;
                    logistics_info.goods_yard_name = goods_yard_name;
                    logistics_info.transfer_order_num = transfer_order_num;
                    logistics_info.delivery_date = delivery_date;
                    logistics_info.count = count;
                    logistics_info.user_id = user_id;                         //登陆ID
                    logistics_info.time_stamp = time_stamp === "" ? "2000-01-01": time_stamp;                          //无
                    retArray[i - 1] = logistics_info;
                }
                return retArray;
            }

            //页面间数据传递
            function getUncofgInfoUI() {
                return uncofginfo;
            }
            //添加一条物流信息 data == null 表示新增一条空数据
            function addLogisticsItem(data,tableindex) {
                var jq = layui.jquery;
                if (!tableindex){
                    tableindex = jq('#tablelogistics')[0].rows.length;
                }
                var laydate = layui.laydate;
                var form = layui.form;
                var logistics_id = "";
                var cs_id = "";
                var goods_yard_name = "";
                var transfer_order_num = "";
                var delivery_date = "";
                var count = "";
                var user_id = "";//data['user_id'];                         //登陆ID
                var time_stamp = "";                           //无
                if (data != null){
                    logistics_id = data.logistics_id;
                    cs_id = data.cs_id;
                    goods_yard_name = data.goods_yard_name;
                    transfer_order_num = data.transfer_order_num;
                    delivery_date = data.delivery_date;
                    count = data.count;
                    user_id = data.user_id;//data['user_id'];                         //登陆ID
                    time_stamp = data.time_stamp = '2000-01-01';                           //无
                }

                var new_tr = jq('#tablelogistics')[0].insertRow(tableindex);//指定位置插入行
                jq(new_tr).attr("logistics_id",logistics_id);
                jq(new_tr).attr("cs_id",cs_id);
                jq(new_tr).attr("goods_yard_name",goods_yard_name);
                jq(new_tr).attr("transfer_order_num",transfer_order_num);
                jq(new_tr).attr("delivery_date",delivery_date);
                jq(new_tr).attr("count",count);
                jq(new_tr).attr("user_id",user_id);
                jq(new_tr).attr("time_stamp",time_stamp);

                // var col_0 = new_tr.insertCell(0);//添加列
                // col_0.innerHTML = "<td><input name ='onechoose' type='checkbox' lay-skin='primary' style='margin: 0px'></td>";
                var col_0 = new_tr.insertCell(0);//添加列
                col_0.innerHTML = "<td><input type= 'text' autocomplete='on' class= 'layui-input Wheat time-item logistics' value='"+ delivery_date +"'></td>";
                jq.each(jq(".time-item"),function(){
                    laydate.render({ elem: this });
                });
                var col_1 = new_tr.insertCell(1);//添加列
                col_1.innerHTML = "<td><input type= 'text' autocomplete='on' class= 'layui-input Wheat logistics' value='"+ goods_yard_name +"'></td>";
                var col_2 = new_tr.insertCell(2);//添加列
                col_2.innerHTML = "<td><input type= 'text' autocomplete='on' class= 'layui-input Wheat logistics' value='"+ transfer_order_num +"'></td>";
                var col_3 = new_tr.insertCell(3);//添加列
                col_3.innerHTML = "<td><input type= 'text' autocomplete='on' class= 'layui-input Wheat logistics' value='"+ count +"' oninput='detectinputnumber(this);'></td>";
                form.render('checkbox');
            }
            //将数据显示
            function setDBDateToHtml(dbData) {  //缺文件
                var jq = layui.jquery;
                jq('#save').addClass('hide');
                if (!dbData){
                    layer.msg('数据加载失败！',{icon:2});
                    return;
                }
                console.log(dbData);
                var order_goods_cs_info = dbData.cs_info;
                var fee_info = dbData.fee_info;
                var cs_belong = dbData.cs_belong;
                var ofg_info = dbData.ofg_info;
                var unc_ofg_detail = dbData.unc_ofg_detail;
                var unc_ofg_info = dbData.unc_ofg_info;
                var ogcugi = dbData.ogcugi;
                var logistic_info = dbData.logistic_info;

                //order_goods_cs_info
                //order_goods_info
                //fee_info
                cs_id = order_goods_cs_info.cs_id;
                ofg_info_id = order_goods_cs_info.ofg_info_id;
                fee_info_id = order_goods_cs_info.fee_info_id;
                unc_ofg_info_id = order_goods_cs_info.unc_ofg_info_id;
                consult_sheet_file = order_goods_cs_info.consult_sheet_file;
                jq('#cs_id').val(cs_id);
                jq('#order_date').val(order_goods_cs_info.order_date);

                $("#divorderproduct input[type='text']").each(function(){
                    for(var p in order_goods_cs_info){
                        if(this.id == p){
                            this.value = order_goods_cs_info[p];
                        }
                    }
                });
                /*jq('#delivered_total').val(order_goods_cs_info.delivered_total);
                jq('#delivered_customization').val(order_goods_cs_info.delivered_customization);
                jq('#delivered_album').val(order_goods_cs_info.delivered_album);
                jq('#delivered_gift').val(order_goods_cs_info.delivered_gift);
                jq('#delivered_aux').val(order_goods_cs_info.delivered_aux);
                jq('#delivered_metro').val(order_goods_cs_info.delivered_metro);
                jq('#delivered_record').val(order_goods_cs_info.delivered_record);
                jq('#delivered_conference').val(order_goods_cs_info.delivered_conference);
                jq('#delivered_pa').val(order_goods_cs_info.delivered_pa);*/

                //consult_sheet_file = order_goods_cs_info.consult_sheet_file;
                //jq('#unc_ofg_info_id').val(order_goods_cs_info.unc_ofg_info_id);
                if(order_goods_cs_info.delivery_date_reply != ''&&order_goods_cs_info.delivery_date_reply != '2000-01-01'&&order_goods_cs_info.delivery_date_reply == null)
                    jq('#delivery_date_reply').val(order_goods_cs_info.delivery_date_reply);
                document.getElementById('cs_info_state').value = order_goods_cs_info.cs_info_state;

                fee_info_id = fee_info.fee_info_id;
                //jq('#fee_info_id').val(fee_info.fee_info_id);
                jq('#customization_fee').val(fee_info.customization_fee);
                document.getElementById('transfer_fee').value = fee_info.transfer_fee;
                document.getElementById('transfer_mode').value = fee_info.transfer_mode;
                jq('#comment').val(fee_info.comment);

                //jq('#delivery_date_reply').val(fee_info.delivery_date_reply);
                //
                jq('#build_organize_id').val(cs_belong.build_organize_id);
                LoadingDepartmentAndSelected(cs_belong.build_organize_id,cs_belong.build_department_id);
                jq('#user_id').val(cs_belong.build_user_name);
                user_id = cs_belong.build_user_id;
                jq('#cs_belong_create_time').val(cs_belong.cs_belong_create_time);
                cs_belong_create_time = cs_belong.cs_belong_create_time;
                cs_belong_id = cs_belong.cs_belong_id;

                ofg_info_id = ofg_info.ofg_info_id;
                //jq('#ofg_info_id').val(ofg_info.ofg_info_id);
                jq('#receiver_name').val(ofg_info.receiver_name);
                jq('#receiver_phone').val(ofg_info.receiver_phone);
                jq('#receiver_address').val(ofg_info.receiver_address);
                //document.getElementById('user_id').value = ofg_info.user_id;

                if (unc_ofg_info != ""){
                    uncofginfo = new Object();
                    uncofginfo.unc_ofg_info = unc_ofg_info;
                    uncofginfo.unc_ofg_items = unc_ofg_detail;
                    uncofginfo.del_unc_ofg_detail_id_arr = null;
                }
                if (logistic_info != ""){
                    var length = logistic_info.length;
                    for (var i = 0; i < length; i++){
                        addLogisticsItem(logistic_info[i],i + 1);
                    }
                }else {
                    //addLogisticsItem(null);
                }
                // addLogisticsItem(null);                     //物流信息
                //否则 addLogisticsItem(data);

                if (ogcugi != ""){
                    var length = ogcugi.length;
                    for (var i = 0; i < length; i++){
                        switch (ogcugi[i]['ogcugi_product_state']){
                            case 0:
                                ogcugi[i]['ogcugi_product_state_text'] = '未发货';
                                break;
                            case 1:
                                ogcugi[i]['ogcugi_product_state_text'] = '处理中';
                                break;
                            case 2:
                                ogcugi[i]['ogcugi_product_state_text'] = '已完成';
                                break;
                            case 3:
                                ogcugi[i]['ogcugi_product_state_text'] = '取消';
                                break;
                            case 4:
                                ogcugi[i]['ogcugi_product_state_text'] = '备货';
                                break;
                            case 5:
                                ogcugi[i]['ogcugi_product_state_text'] = '缺货';
                                break;
                            default:
                                ogcugi[i]['ogcugi_product_state_text'] = '';
                                break;
                        }
                        addGoodsTableRow();
                        setGoodsRowValue( ogcugi[i],i+1);
                    }
                }
                layui.form.render('select');
                return;
            }
            //获取子部门并选中
            function LoadingDepartmentAndSelected(value,selectValue) {
                var jq = layui.jquery;
                jq('#build_department_id').empty();
                jq('#user_id').empty();
                jq('#build_department_id').append("<option value='' selected>请选择</option>");
                jq('#user_id').append("<option value='' selected>请选择</option>");
                layui.form.render('select');
                jq.post("{:url('admin/addgoodsconfirmorder/getdepartmentinfo')}",{'param':value},function(data){
                    for(var  item in data){
                        if(data[item]['organize_id'] == selectValue)
                        {
                            jq("#build_department_id").append("<option value='"+data[item]['organize_id']+"' selected>"+data[item]['organize_name']+"</option>");
                        }

                        else
                            jq("#build_department_id").append("<option value='"+data[item]['organize_id']+"'>"+data[item]['organize_name']+"</option>");
                    }
                    layui.form.render('select');
                });
            }
            //获取经理并选中
            function LoadingManagerAndSelected(value,selectValue) {
                var jq = layui.jquery;
                jq('#user_id').empty();
                jq('#user_id').append("<option value='' selected>请选择</option>");
                layui.form.render('select');
                jq.post("{:url('admin/addgoodsconfirmorder/getdspmanagerinfo')}",{'param':value},function(data){
                    for(var  item in data){
                        if(data[item]['user_id'] == selectValue)
                        {
                            jq("#user_id").append("<option value='"+data[item]['user_id']+"' selected>"+data[item]['fullname']+"</option>");
                        }

                        else
                            jq("#user_id").append("<option value='"+data[item]['user_id']+"'>"+data[item]['fullname']+"</option>");
                    }
                    layui.form.render('select');
                });
            }

            function editSaveData() {
                if(isLoading){
                    return false;
                }
                // var logistics_info = getlogisticsInfo();
                // if(logistics_info == null){
                //     layer.msg('请填写完整物流信息！',{icon:2});
                //     return false;
                // }
                // var logistics_info_length = logistics_info.length;
                // if(logistics_info_length < 1){
                //     layer.msg('请填写物流信息！',{icon:2});
                //     return false;
                // }
                var jq = layui.jquery;
                var data = [];
                var obj = jq("form").serializeArray();                                  //获取表单数据
                for (var i = 0; i < obj.length;i++){
                    data[obj[i].name] = obj[i].value;
                }
                //var data = uidata.field;
                var retVf = verification(data);
                if(!retVf){
                    return false;
                }
                // console.log(data);
                // console.log('下列输入物流信息：');
                // console.log(logistics_info);
                var order_goods_cs_info = getorderGoodsInfo(data);
                console.log('下列输入订货确认单信息：');
                console.log(order_goods_cs_info);
                var cs_belong = csBelong(data);
                console.log('下列输入订货所属信息：');
                console.log(cs_belong);
                var ofg_info = ofgInfo(data);
                console.log('下列输入订单信息：');
                console.log(ofg_info);
                var fee_info = feeInfo(data);
                console.log('下列输入费用情况：');
                console.log(fee_info);
                var order_goods_cs_undeliver_goods_info = getGoodsTable();
                if(order_goods_cs_undeliver_goods_info == false)
                    return false;
                console.log('下列输入清单信息：');
                console.log(order_goods_cs_undeliver_goods_info);
                var unc_ofg_info = null;
                var unc_ofg_detail = null;
                if (uncofginfo != null){
                    del_unc_ofg_detail_id_arr = uncofginfo.del_unc_ofg_detail_id_arr;
                    unc_ofg_info = uncofginfo.unc_ofg_info;
                    var unc_ofg_items = uncofginfo.unc_ofg_items;
                    var length = unc_ofg_items.length;
                    for (var i = 0; i < length; i++){
                        if (unc_ofg_detail == null){
                            unc_ofg_detail = [];
                        }
                        if(unc_ofg_items[i]['isExistModel'] == undefined || unc_ofg_items[i]['isExistModel'] == null||unc_ofg_items[i]['isExistModel'] == '')
                        {
                            unc_ofg_items[i]['isExistModel'] = true;
                        }
                        if(unc_ofg_items[i]['unc_product_id'] == undefined || unc_ofg_items[i]['unc_product_id'] == null||unc_ofg_items[i]['unc_product_id'] == '')
                        {
                            unc_ofg_items[i]['unc_product_id'] = -1;
                        }

                        unc_ofg_detail[i] = unc_ofg_items[i];
                    }
                }
                console.log('下列非常规订单信息：');
                console.log(unc_ofg_info);
                console.log('下列非常规清单信息：');
                console.log(unc_ofg_detail);
                console.log(del_logistics_id_arr);
                console.log(del_unc_ofg_detail_id_arr);
                console.log(del_ogcugi_id_arr);
                var retBo = false;
                jq.ajax({
                    url: "{:url('admin/addgoodsconfirmorder/editcs')}",//php文件路径
                    data: {
                        order_goods_cs_info:order_goods_cs_info,
                        //logistics_info:logistics_info,
                        cs_belong:cs_belong,
                        ofg_info:ofg_info,
                        fee_info:fee_info,
                        order_goods_cs_undeliver_goods_info:order_goods_cs_undeliver_goods_info,
                        unc_ofg_info:unc_ofg_info,
                        unc_ofg_detail:unc_ofg_detail,
                        del_logistics_id_arr:del_logistics_id_arr,
                        del_unc_ofg_detail_id_arr:del_unc_ofg_detail_id_arr,
                        del_ogcugi_id_arr:del_ogcugi_id_arr,
                    },
                    type: 'POST',
                    async: false,
                    success: function(e) {
                        var layer = layui.layer;
                        if (e != null){
                            if(e.code == 1){
                                isSave = true;
                                retBo = true;
                                top.layer.msg(e.msg);
                            }else if(e.code == 0){
                                layer.alert(e.msg)
                            }else if(e.code == -1){
                                top.layer.alert('异常：' + e.msg);
                            }
                        }else {
                            top.layer.alert('保存失败！');
                        }
                    }
                })
                return retBo;
            }

            function setHtmlType(isLoading) {
                if (type == 0){
                    var inputTextArray=$("input[type='text']");
                    inputTextArray.each(
                        function (){
                            var input =$(this)[0];
                            $(input).attr('disabled',true);
                        }
                    )
                    var inputBtnArray=$("input[type='button']");
                    inputBtnArray.each(
                        function (){
                            var input =$(this)[0];
                            //$(input).addClass('hide');
                            var id = $(input).attr('id');
                            if (id != 'lookuncofginfo' && id != 'lookpic'){
                                $(input).addClass('layui-disabled');
                                $(input).attr("disabled","disabled");
                            }
                            else {
                            }
                        }
                    )
                    var selectArray = $("select");
                    selectArray.each(
                        function (){
                            var input =$(this)[0];
                            $(input).attr('disabled',true);

                        }
                    )
                    $('#comment').attr('disabled',true);
                }else {

                }
                setDelUncofginfoVis();
                setConsultSheet();
                //屏蔽物流，禁止修改
                $(".logistics").each(function(){
                    $(this).attr('disabled',true);
                });
                layui.form.render('select');
            }

            function setConsultSheet() {
                if(consult_sheet_file == "" && consult_sheet_file_new == ""){
                    $('#lookpic').attr("disabled","disabled");
                    $('#lookpic').addClass('btnPicLightBg');
                }else {
                    $('#lookpic').removeAttr("disabled");
                    $('#lookpic').removeClass('btnPicLightBg');
                }
                if (consult_sheet_file_new != ""){
                    $('#delpic').removeClass('hide');
                }else {
                    $('#delpic').addClass('hide');
                }
            }

            function setDelUncofginfoVis() {
                if (type == 0){
                    if(uncofginfo == "" || uncofginfo == null || uncofginfo === undefined){
                        $('#deluncofginfo').addClass('hide');
                        $('#lookuncofginfo').attr("disabled","disabled");
                        $('#lookuncofginfo').addClass('btnPicLightBg');
                    }else {
                        $('#deluncofginfo').addClass('hide');
                        $('#lookuncofginfo').removeAttr("disabled");
                        $('#lookuncofginfo').removeClass('btnPicLightBg');
                    }
                }else {
                    if(uncofginfo == "" || uncofginfo == null || uncofginfo === undefined){
                        $('#deluncofginfo').addClass('hide');
                        $('#lookuncofginfo').attr("disabled","disabled");
                        $('#lookuncofginfo').addClass('btnPicLightBg');
                    }else {
                        $('#deluncofginfo').removeClass('hide');
                        $('#lookuncofginfo').removeAttr("disabled");
                        $('#lookuncofginfo').removeClass('btnPicLightBg');
                    }
                }
            }
            //删除未保存咨询表
            function delCacheConsultSheet() {
                if (consult_sheet_file_new == ""){
                    return;
                }
                var jq = layui.jquery;
                jq.ajax({
                    url: "{:url('admin/addgoodsconfirmorder/delcachefile')}",//php文件路径
                    data: {
                        delFileName:consult_sheet_file_new
                    },
                    type: 'POST',
                    success: function(res) {
                        console.log(res)
                        consult_sheet_file_new = "";
                        if(res.code){
                            top.layer.msg(res.msg,{icon:1});
                        }else {
                            top.layer.msg(res.msg,{icon:2});
                        }
                        setConsultSheet();
                    }
                })
            }
            
            function verification(data) {
                console.log(data);
                var layer = layui.layer;

                var order_date = data['order_date'].trim();
                if (order_date == ""){
                    layer.msg('请选择接收时间！',{icon:2});
                    return false;
                }

                var cs_info_state = data['cs_info_state'];
                if (cs_info_state == '' || cs_info_state == -1){
                    layer.msg('请选择状态！',{icon:2});
                    return false;
                }

                var build_organize_id = data['build_organize_id'];
                if (build_organize_id == ""|| build_organize_id == undefined){
                    layer.msg('请选择总部门！',{icon:2});
                    return false;
                }

                var build_department_id = data['build_department_id'];
                if (build_department_id == ""|| build_organize_id == undefined){
                    layer.msg('请选择子部门！',{icon:2});
                    return false;
                }

                 var user_id = data['user_id'];
                 if (user_id == ""|| build_organize_id == undefined){
                     layer.msg('请输入经理！',{icon:2});
                     return false;
                 }
                var transfer_mode = data['transfer_mode'];
                if (transfer_mode == "" || transfer_mode === undefined){
                    data['transfer_mode'] = -1;
                }

                // var receiver_name = data['receiver_name'].trim();
                // if (receiver_name == "" || receiver_name === undefined){
                //     layer.msg('请填写收货人姓名！',{icon:2});
                //     return false;
                // }
                // var receiver_phone = data['receiver_phone'].trim();
                // if (receiver_phone == "" || receiver_phone === undefined){
                //     layer.msg('请填写收货人电话！',{icon:2});
                //     return false;
                // }
                // var receiver_address = data['receiver_address'].trim();
                // if (receiver_address == "" || receiver_address === undefined){
                //     layer.msg('请填写收货地址！',{icon:2});
                //     return false;
                // }
                // var customization_fee = data['customization_fee'].trim();
                // if (customization_fee == "" || customization_fee === undefined){
                //     layer.msg('请填订制费用！',{icon:2});
                //     return false;
                // }
                // var transfer_fee = data['transfer_fee'].trim();
                // if (transfer_fee == "" || transfer_fee === undefined){
                //     layer.msg('请填运费！',{icon:2});
                //     return false;
                // }
                var delivery_date_reply = data['delivery_date_reply'].trim();
                if(delivery_date_reply == ""){
                    data['delivery_date_reply'] = '2000-01-01';
                }
                return true;
            }

            //增加清单一行
            var rowIndex = 0;
            function addGoodsTableRow() {
                var jq = layui.jquery;
                var rowNum = jq('#tableorder')[0].rows.length;
                var newRow = jq('#tableorder')[0].insertRow(rowNum);//指定位置插入行

                //保存每一行的标志
                jq(newRow).attr('rowIndex',rowIndex);
                jq(newRow).attr('ogcugi_id',"");
                jq(newRow).attr('cs_id',"");
                jq(newRow).attr('isExistModel',true);
                var col = newRow.insertCell(0);//添加列
                col.innerHTML = "<td ><a style='margin: 0px 10px' >"+rowNum+"</a></td>";
                col = newRow.insertCell(1);
                col.innerHTML = "<td><input type='text' id ='model"+rowIndex+"' class='layui-input autocomplete-input ' style='color: #0C0C0C ;border:0px'/></td>";
                col = newRow.insertCell(2);
                col.innerHTML ="<td ><input type='text' id='product_info_name"+rowIndex+"' class='layui-input ' style='color: #0C0C0C ;border:0px'/></td>";
                col = newRow.insertCell(3);
                col.innerHTML ="<td ><select id='product_type_id"+rowIndex+"' style='border: none;' name='product_type_id'  class=' select-style-border-none' > <option value='' selected>请选择</option>{volist name='producttypelist' id='vo'} <option value={$vo.product_type_id}>{$vo.product_type_name}</option>{/volist} </select></td>";
                col = newRow.insertCell(4);
                col.innerHTML ="<td><select id='brand_id"+rowIndex+"' style='color: #0C0C0C ;border:0px' name='brand_name' lay-filter='brand_name' class=' select-style-border-none'> <option value='' selected>请选择</option>{volist name='brandlist' id='vo'};col_1.innerHTML =<option value={$vo.brand_id}>{$vo.brand_name}</option>{/volist} </select></td>";
                col = newRow.insertCell(5);
                col.innerHTML ="<td><select id='place_id"+rowIndex+"' style='color: #0C0C0C ;border:0px' name='place_name' lay-filter='place_name' class=' select-style-border-none' > <option value='' selected>请选择</option>{volist name='placelist' id='vo'} <option value={$vo.place_id}>{$vo.place_name}</option>{/volist} </select></td>";
                col = newRow.insertCell(6);
                col.innerHTML ="<td><input type='text' id='ogcugi_unit"+rowIndex+"' name='ogcugi_unit' class='layui-input  ' style='color: #0C0C0C ;border:0px' oninput='detectinputtext(this);'></td>";
                col = newRow.insertCell(7);
                col.innerHTML ="<td><input type='text' id='ogcugi_count"+rowIndex+"' name='ogcugi_count' class='layui-input  ' style='color: #0C0C0C ;border:0px' oninput='detectinputnumber(this);'></td>";
                col = newRow.insertCell(8);
                col.innerHTML ="<td><select id='ogcugi_product_state"+rowIndex+"' name='ogcugi_product_state' lay-filter='unc_productname' class='select-style-border-none '> " +
                    "<option value='' selected>请选择</option> " +
                    " <option value='0'>未发货</option>" +
                    "<option value='1'>处理中</option>" +
                    "<option value='2'>已完成</option>" +
                    "<option value='3'>取消</option>" +
                    "<option value='4'>备货</option>" +
                    "<option value='5'>缺货</option></select></td>";
                col = newRow.insertCell(9);
                col.innerHTML ="<td><input type='text' id='ogcugi_comment"+rowIndex+"' name='ogcugi_comment' class='layui-input  ' style='color: #0C0C0C ;border:0px' oninput='detectinputtext(this);'></td>";
                col = newRow.insertCell(10);
                col.innerHTML ="<td><a class='layui-btn layui-btn-xs layui-btn-danger del_btn ' style = 'margin: 0px 10px '>删除</a></td>";

                var model ="#"+ "model"+rowIndex;
                $(model).autocomplete({
                    source: function (request, response) {
                        var serachText = $(model).val().trim();
                        console.log(11);
                        jq.ajax({
                            url: "{:url('index/common/serachmodelinfo')}",
                            type: "POST",
                            dataType: "json",
                            data: { serrchText:serachText},
                            success: function (data) {
                                response(jq.map(data, function (item) {
                                    return {
                                        label: item.model,
                                        value: item.model,
                                    }
                                }));
                            },
                        });},
                    select:function (event,ui) {
                        jq(model).val(ui.item.value);
                        jq(model).blur();
                    }
                });
                var product_info_name = "#"+"product_info_name"+ rowIndex ;
                var product_type_id = "#"+"product_type_id"+rowIndex ;
                var brand_id = "#"+"brand_id"+rowIndex ;
                var place_id = "#"+"place_id"+rowIndex ;
                $(model).blur(function () {
                    var modelname = jq(model).val();
                    if(modelname == '')
                        return ;
                    jq.ajax({
                        url: "{:url('index/Common/coldserachmodelinfo')}",
                        type: "POST",
                        dataType: "json",
                        async: false,
                        data: { serrchText: modelname},
                        success: function (data) {
                            if(data == "" || data == null || data === undefined||data.length == 0) {
                                console.log(173);
                                top.layer.confirm('型号: <span style="color: red">'+modelname+'</span> 在数据库不存在，是否录入', {
                                    btn: ['是','否'] //按钮
                                }, function(index){
                                    isExistModel = false;
                                    top.layer.close(index);
                                    jq(newRow).attr('isExistModel',false);
                                    jq(newRow).attr('product_info_id','');
                                    if(jq('#tableorder')[0].rows.length-1 == rowNum )
                                    {
                                        addGoodsTableRow();
                                    }
                                } ,function () {
                                    jq(model).val('');
                                    jq(model).focus();
                                });
                            } else {
                                jq(product_info_name).val(data[0]['product_info_name']);
                                jq(product_type_id).val(data[0]['product_type_id']);
                                jq(brand_id).val(data[0]['brand_id']);
                                jq(place_id).val(data[0]['place_id']);
                                jq(newRow).attr('product_info_id',data[0]['product_info_id']);
                                ///还要处理
                                layui.form.render('select');

                                jq(newRow).attr('isExistModel',true);
                                if(jq('#tableorder')[0].rows.length-1 == rowNum)
                                {
                                    addGoodsTableRow();
                                }
                            }
                        },
                    });


                });
                rowIndex++;

                layui.form.render('select');
            }
            //给清单赋值
            function setGoodsRowValue(data,rowNum) {
                console.log(data);
                var table = document.getElementById('tableorder');
                var row = table.rows[rowNum];
                var rowIndex = $(row).attr('rowIndex');
                $(row).attr('ogcugi_id',data['ogcugi_id']);
                $(row).attr('product_info_id',data['product_info_id']);
                $(row).attr('cs_id',data['cs_id']);
                $(row).attr('isExistModel',true);
                $('#model'+rowIndex).val(data['model']);
                $('#product_info_name'+rowIndex).val(data['product_info_name']);
                $('#product_type_id'+rowIndex).val(data['product_type_id']);
                $('#brand_id'+rowIndex).val(data['brand_id']);
                $('#place_id'+rowIndex).val(data['place_id']);
                $('#ogcugi_count'+rowIndex).val(data['ogcugi_count']);
                $('#ogcugi_unit'+rowIndex).val(data['ogcugi_unit']);
                $('#ogcugi_product_state'+rowIndex).val(data['ogcugi_product_state']);
                $('#ogcugi_comment'+rowIndex).val(data['ogcugi_comment']);
            }
            //获取全部清单，错误返回false
            function getGoodsTable() {
                var table = document.getElementById('tableorder');
                if(table.rows.length <=1)
                    return null;
                var data = Array();
                for(var i =1 ;i< table.rows.length;i++)
                {
                    var row = table.rows[i];
                    var rowIndex = $(row).attr('rowIndex');
                    if($("#model"+rowIndex).val() == ''&& i != table.rows.length-1)
                    {
                        top.layer.msg('订购清单第'+i+'行型号不能为空',{icon:2});
                        return false;
                    }
                    else if($("#model"+rowIndex).val() == ''&& i == table.rows.length-1)
                    {
                        break;
                    }
                    var rowdata = {};
                    rowdata.model = $("#model"+rowIndex).val();
                    rowdata.product_info_name = $('#product_info_name'+rowIndex).val();
                    rowdata.product_type_id = $('#product_type_id'+rowIndex).val();
                    if(rowdata.product_type_id == "" || rowdata.product_type_id == undefined || rowdata.product_type_id == null){
                        top.layer.msg('订购清单第'+i+'行，请输入产品分类',{icon:2});
                        return false;
                    }
                    rowdata.brand_id = $('#brand_id'+rowIndex).val();
                    if(rowdata.brand_id == "" || rowdata.brand_id == undefined || rowdata.brand_id == null){
                        top.layer.msg('订购清单第'+i+'行，请输入品牌',{icon:2});
                        return false;
                    }
                    rowdata.place_id = $('#place_id'+rowIndex).val();//
                    if(rowdata.place_id == "" || rowdata.place_id == undefined || rowdata.place_id == null){
                        rowdata.place_id = -1;
                    }
                    rowdata.ogcugi_unit = $('#ogcugi_unit'+rowIndex).val();
                    rowdata.ogcugi_count = $('#ogcugi_count'+rowIndex).val();
                    if(rowdata.ogcugi_count == "" || rowdata.ogcugi_count == undefined || rowdata.ogcugi_count == null){
                        top.layer.msg('订购清单第'+i+'行，请输入数量',{icon:2});
                        return false;
                    }
                    rowdata.ogcugi_product_state = $('#ogcugi_product_state'+rowIndex).val();
                    if(rowdata.ogcugi_product_state == "" || rowdata.ogcugi_product_state == undefined || rowdata.ogcugi_product_state == null){
                        rowdata.ogcugi_product_state = -1;
                    }
                    rowdata.ogcugi_comment = $('#ogcugi_comment'+rowIndex).val();
                    rowdata.ogcugi_id = $(row).attr('ogcugi_id');
                    rowdata.product_info_id = $(row).attr('product_info_id');
                    rowdata.cs_id = $(row).attr('cs_id');
                    rowdata.isExistModel = $(row).attr('isExistModel');
                    data[i-1]=rowdata;
                }
                return data;
            }

            String.prototype.replaceAll = function(reallyDo, replaceWith, ignoreCase) {
                if(!RegExp.prototype.isPrototypeOf(reallyDo)) {
                    return this.replace(new RegExp(reallyDo, (ignoreCase ? "gi" : "g")), replaceWith);
                } else {
                    return this.replace(reallyDo, replaceWith);
                }
            }
        </script>
    </body>
</html>